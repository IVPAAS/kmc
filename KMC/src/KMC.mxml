<?xml version="1.0" encoding="utf-8"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" 
				xmlns:view="com.kaltura.kmc.view.*" 
				layout="absolute" minWidth="955" minHeight="600"
				creationComplete="creationCompleteHandler(event)" 
				addedToStage="setNavigationListener(event)">
	
		
	<mx:Script>
		<![CDATA[
			import com.kaltura.KalturaClient;
			import com.kaltura.commands.uiConf.UiConfGet;
			import com.kaltura.config.KalturaConfig;
			import com.kaltura.events.KalturaEvent;
			import com.kaltura.kmc.business.KmcModuleLoader;
			import com.kaltura.kmc.events.KmcModuleEvent;
			import com.kaltura.kmc.events.KmcNavigationEvent;
			import com.kaltura.kmc.model.KmcModelLocator;
			import com.kaltura.kmc.modules.KmcModule; KmcModule
			import com.kaltura.kmc.modules.dashboard.Dashboard;
			import com.kaltura.kmc.vo.DashboardContext;
			import com.kaltura.utils.KUtils;
			import com.kaltura.utils.ObjectHelpers;
			
			import flash.utils.setTimeout;
			
			import mx.core.Application;
			import mx.core.UIComponent;
			import mx.events.FlexEvent;

			public var uiConfXml:XML = 	<root>
										<!-- path to skin file -->
										<skinPath>http://www.../kmcSkin.swf</skinPath>
										<!-- path to help page -->
										<helpPage>http://www.../helpPage.html</helpPage>
									
										<!-- login data -->
										<login>18125</login>
										
										<!-- dashboard data -->
										<dashboard>12132</dashboard>
										
										<!-- studio data -->
										<studio>12135</studio>
											
										<!-- Content data -->
										<content>32132</content>
										
										<!-- account data -->
										<settings>132132</settings>
										
										<!-- analytics data -->
										<analytics>321654</analytics>
									
									</root> ;

			private var modelLocator:KmcModelLocator =  KmcModelLocator.getInstance();
			
			protected var flashvars:Object;
			
			
			
			protected function creationCompleteHandler(event:FlexEvent):void
			{
				
				//TODO add the config from the outside 
				var objParam:Object = Application.application.parameters;
				objParam = ObjectHelpers.lowerNoUnderscore(objParam); 
				flashvars = objParam;
				
				var configuration:KalturaConfig = new KalturaConfig();
				configuration.partnerId = objParam.partnerid;
				configuration.ignoreNull = 1;
				configuration.protocol = objParam.protocol ? objParam.protocol : "http://";
				configuration.domain = KUtils.hostFromCode(objParam.host);
				configuration.srvUrl = objParam.srvurl;
				configuration.clientTag = "kmc";
				
				modelLocator.kalturaClient = new KalturaClient(configuration);
				modelLocator.kalturaClient.ks = objParam.ks;
				
//				var uiconf:UiConfGet = new UiConfGet(objParam.kmcuiconf);
//				uiconf.addEventListener(KalturaEvent.COMPLETE, uiconfLoadHandler);
//				uiconf.addEventListener(KalturaEvent.FAILED, uiconfFailedHandler);
//				modelLocator.kalturaClient.post(uiconf);
				uiconfLoadHandler(null);
			}

			
			/**
			 * UiConf failed to load
			 */
			protected function uiconfFailedHandler(event:KalturaEvent):void
			{
				//TODO implement uiconfFailedHandler
			}
			
			/**
			 * module failed to load
			 */
			protected function onModuleLoadError(event:KmcModuleEvent):void
			{
				throw new Error("KMC.mxml: Module load failed.");
			}
			
			/**
			 * Kmc uiConf loaded. Parse it and load it. 
			 */
			protected function uiconfLoadHandler(event:KalturaEvent):void
			{
				//TODO - parse 
				KmcModuleLoader.getInstance().loadKmcModule("com/kaltura/kmc/modules/dashboard/Dashboard.swf");
				KmcModuleLoader.getInstance().addEventListener(KmcModuleEvent.MODULE_LOADED , onModuleLoaded);
				KmcModuleLoader.getInstance().addEventListener(KmcModuleEvent.MODULE_LOAD_ERROR , onModuleLoadError);
			}
			
		
			private function onModuleLoaded(event:KmcModuleEvent):void
			{
				KmcModuleLoader.getInstance().removeEventListener(KmcModuleEvent.MODULE_LOADED , onModuleLoaded);
				KmcModuleLoader.getInstance().removeEventListener(KmcModuleEvent.MODULE_LOAD_ERROR , onModuleLoadError);
				(event.moduleLoader.child as UIComponent).percentHeight = 100;
				(event.moduleLoader.child as UIComponent).percentWidth = 100;
				mainViewStack.addChild(event.moduleLoader);
				mainViewStack.selectedIndex = 0;
				
				// dashboard params:
				var dc:DashboardContext = new DashboardContext();
				dc.customizedoclink = flashvars.customizedoclink;
				dc.embeddoclink = flashvars.embeddoclink;
				dc.firstlogin = flashvars.firstlogin;
				dc.gaDebug = flashvars.gaDebug;
				dc.uploaddoclink = flashvars.uploaddoclink;
				dc.urchinnumber = flashvars.urchinnumber;
				dc.username = flashvars.username;
				dc.uid = flashvars.uid;
				
				// init dashboard:
				(event.moduleLoader.child as KmcModule).init(KmcModelLocator.getInstance().kalturaClient, "1002374", dc);
			}
			
			/**
			 * Switch to a different KMC module (tab).
			 * Can also include subtab on the new module.
			 * @param e		event holding navigation request info.
			 * */
			private function navigateToModule(e:KmcNavigationEvent):void {
				trace("KMC going to", e.module, e.subtab != null ? "> " + e.subtab : "");
			}


			protected function setNavigationListener(event:Event):void
			{
				this.addEventListener(KmcNavigationEvent.NAVIGATE, navigateToModule);
			}

		]]>
	</mx:Script>
	<view:MainViewStack id="mainViewStack" width="100%" height="100%" />
</mx:Application>
